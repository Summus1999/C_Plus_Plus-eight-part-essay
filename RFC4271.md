# RFC4271

BGP协议的主要功能是与其他BGP系统交换网络可达性信息。
网络可达性信息包括可达性信息所遍历的自治系统(AS)列表上的信息。这些信息足够构建AS网络拓扑连接图，从中可以修剪路由循环。而且在AS级别，可以强制执行一些路由策略。

BGP4协议还提供了一种CIDR(支持无类域间路由)机制,减少路由表条目的转发，降低路由表的规模，缓解BGP的会话带宽压力。IPv4地址有ABC类地址之分，BGP4协议也一起摒弃了。BGP4协议还引入了路由聚合和AS聚合的机制，后面会讲。

**CIDR机制**：多个连续的IP地址块聚合成一个​CIDR前缀，减少路由表条目，降低路由表规模，缓解BGP会话的带宽压力。

## 1.介绍

BGP协议仅支持基于目的地址的转发范式，这一设计从根本上限制了其可实施的路由策略类型。
BGP报文转发决策流程：
BGP路由器根据目的地址匹配路由表中的前缀，选择最优路径（如最短AS_PATH或最高LOCAL_PREF），并将数据包转发给下一跳。​整个过程**仅依赖目的地址**，与数据包的其他属性无关。

### 1.1常用术语的定义

本节主要介绍一些专业术语。
RIB_in:路由输入，即外部输入到本ASspeaker的路由表信息。
RIB_out:路由输出，即内部输出到其他ASspeaker的路由表信息。
AS:自治系统，​单一技术管理实体下的一组路由器，这些路由器使用​内部网关协议（IGP）和​共同度量标准进行内部路由，同时通过​外部网关协议与其他AS通信。AS对外表现为​单一路由策略实体。
BGP ID：BGP 标识符是BGP协议中用于唯一标识一个BGP Speaker的4字节无符号整数，**为BGP会话提供设备级唯一性保证**。
BGP speaker：BGP发言者，实现BGP协议的路由器。
EBGP:外部网关路由协议，是运行在不同自治系统（AS）之间的BGP实例，其核心功能是实现跨AS的路由信息交换与策略控制。
IBGP:内部网关路由协议，是运行在同一个自治系统（AS）之内的BGP实例，其核心功能是实现AS内部的路由信息交换与策略控制。
External peer：外部对等体，与本地AS不同的另一个对等体。
Internal peer：内部对等体，处于同一AS内的另一个对等体。
local_RIB:包含本地BGP speaker决策过程选择的路由表。
NLRI:网络层可达性信息。
route:路由是网络通信中**决定数据包从源地址到目的地址传输路径的核心机制**，其本质是将目标网络与路径属性绑定的信息单元。
RIB：路由表，又称路由信息库。
Unfeasible route：不可行路线，以前公布的不再可用的可行路线。

### 1.2. 需求说明

RFC文档中的各个要求是不一样的，从MUST到OPTIONAL等级从高到低。

## 2.致谢

略过

## 3.业务概要

边界网关协议（BGP）是一种自治系统间路由协议。
**BGP 发言者仅通告自身实际使用的路由**是路由协议的**核心机制**，本质是路径优选和策略过滤的结合。
可以通过源路由(显式路由)实现指定路径的报文转发。也可以使用策略路由调整报文流量的方向。但是会有**潜在的路由环路和路由黑洞**的问题。
BGP协议使用TCP协议作为其传输协议，使用固定端口179在peer间建立可靠的TCP传输连接。依靠TCP协议，BGP能够保证在连接关闭前将所有报文传输完成。
一般是在两个系统之间建立TCP连接并交换报文信息打开和确认参数。

初始数据流是经过路由策略过滤之后的路由表的一部分，一般通过update报文将有效路由更新到路由网络中。
在TCP连接过程中，BGP speaker会保留所有的当前路由，除非收到update报文。
BGP有keepalive报文保活机制，如果这个选项设置为0则认为关闭该机制。如果连接遇到错误情况，BGP peer将发送通知消息并关闭连接。
内部BGP和外部BGP通常缩写为IBGP和EBGP。

如果一个AS内有多个BGP speaker，此时该AS为其他AS提供中转服务，**需要确保AS内的路由视图是一致的**。由此解决外部路由的认知不一致带来的路由黑洞问题。

### 3.1路由：广告和存储

路由=目标网络前缀​+​路径属性
目标网络前缀：标识路由的终点范围，接收方根据此信息更新本地路由表。
路径属性：控制路由选择、防止环路、实现策略路由。
注意：根据RFC4271，**路由属性分为4种级别**

- 公认必遵：所有 BGP 设备必须识别且必须存在于 Update 报文中，缺少则路由无效，有Origin、AS_Path、Next_Hop
- 公认任意：所有BGP设备必须识别，update报文中可有可无，缺少不影响路由有效性。有Local_Pref、Atomic_Aggregate
- 可选过渡：设备可不识别但必须转发给邻居，支持跨AS传递。有MED、Community、Aggregator
- 可选非传递：设备可不识别且不转发给邻居，仅本地生效。

在BGP peer的对等体广播之前，BGP peer可以修改除了公认必遵之外的三种级别的路由属性，修改路由属性。

BGP**通知路由不可用**的3种方法：

- 发送路由撤销（Withdrawal）消息：当路由失效时，BGP speaker生成​UPDATE报文，在Withdrawn Routes字段中列出不可达路由的前缀,对端peer从路由表中删除该路由表项。
- 更新路由属性标记不可达：在 UPDATE 报文中，对不可达路由的路径属性进行修改，将 NEXT_HOP 设置为无效地址。
- 路由抑制（Dampening）机制：对频繁震荡的路由启动BGP抑制计时器。每次路由变化增加惩罚值，超过阈值后，路由被抑制且不再通告，但是**仍然可以被撤销**。

### 3.2 路由表

RIB=RIB_in+local_RIB+RIB_out

BGP 通过​Adj-RIBs-In、Loc-RIB​和​Adj-RIBs-Out​实现路由的接收、决策和转发控制，而​路由表作为最终执行层，整合所有路由来源并决定实际数据路径。

**路由表的组成**​：
包含所有用于数据转发的路由，包括：
直连网络（Direct）
静态路由（Static）
IGP 路由（如 OSPF、IS-IS 学习的路由）
BGP 路由（从 Loc-RIB 安装的最优路由）

## 4.消息格式

BGP报文的长度为19-4096字节，按大端序传输。

### 4.1消息头格式

BGP报文的报文头是19个字节
BGP报文头=16字节marker字段(未使用认证默认全为1)+2字节length字段+1字节type字段
注意：
marker字段如果启动了认证功能，将不为全1。
length字段即表示本报文的长度
type字段即1 - OPEN开启 2 - UPDATE更新 3 - NOTIFICATION通知 4 - KEEPALIVE保活

![BGP4状态机](image-3.png)

### 4.2 open报文格式

状态机从idle切到connect，会发送open报文

![open报文格式示意图](image-4.png)

open报文的**最短长度**=19+1+2+2+4+1=29字节

- version：1字节，表示当前BGP协议版本，通常使用BGP4，之前的BGP版本都已经被淘汰(顺便说一句，BGP4是BGP协议第四代的意思，和IP地址类型无关)
- my autonomous system:2字节,表示发送方的AS号
- hold time:2字节，保持时间，设置为0则不启用保活机制，设置≥3秒则设置有效的保活机制。
- BGP ID:BGP 标识符，4字节，使用IPv4的地址作为BGP ID。(插一句，一般选取BGP speaker的时候IP地址的优先级是环回地址IP>物理接口IP，且会选取点分十进制较大的IP)
- optional parameter：1字节，**可选的**，包含可选参数列表，其中每个参数都编码为<parameter Type，parameter Length，parameter Value>三元组。(翻译一下就是按TLV格式存储)如果为0则表示后续无可选参数。

### 4.3 update报文格式

update报文的最短长度=19字节报文头+2字节Withdrawn Routes Length+2字节Total Path Attribute Length

update报文用于在BGP peer之间传输路由信息，路由信息可以构建路由拓扑图。
路由环路和路由黑洞这些路由问题可以通过update报文实现故障消除。

update报文用于向对等方公布共享公共路径属性的可行路由，或从服务中撤回多个不可行路由。update报文可**同时公布**可行路由并从服务中撤回多个不可行路由，报文始终包括**固定大小**的BGP标头，还包括其他字段

![update报文格式示意图](image-5.png)

Withdrawn Routes Length：撤销路由长度，2字节，表示后面撤销路由的数目。如撤销3条路由，该字段的值就是3*2=6
Withdrawn Routes：撤销路由，Withdrawn Routes字段的编码格式为<Length, Prefix>。举个例子，10.0.0.0/8长度为8，那么他的length就是8，他的prefix的值就是length/8=8/8=1，**截断**编码表示就是08 0A
Total Path Attribute Length：路径属性总长度，2字节，表示后面发布路由的数目。
Path Attributes：发布路由，每个路径属性都是长度可变的三重<attribute type，attribute length，attribute value>

- type：1字节，第一个字节定义属性是可选的还是公认的(公认属性设置为0)，第二个字节是可传递位，可传递的属性设置为1。
  
注意：

| 路由属性分类       | 可选位 (Optional) | 过渡性 (Transitive) | 完整位(Partial bit)    |
|:-------------------|:------------------|--------------------|:-----------------------|
| **公认必遵**       | 0                | 1                  | 0                   |
| **公认任意**       | 0                | 1                  | 0                   |
| **可选过渡**       | 1                | 1                  | 属性完整时设置为0    |
| **可选非传递**     | 1                | 0                  | 0                   |

type的第4个高位是扩展长度位。如果设置为0就是一个字节表示属性长度，为1则用2个字节表示属性长度。
第一个字节4个低位都设置为0。

路径属性的第二个字节表示属性值：

- origin：值为1，3字节，TLV格式，**公认必遵**属性
- AS_PATH:值为2，头部2字节 + 可变Value，**公认必遵**属性
- NEXT HOP:值为3，1+1+4总共6字节，**公认必遵**属性
- MULTI_EXIT_DISC：值为4，**可选非传递**属性，又称MED，越小路由优先级越高。1+1+4总共6字节
- LOCAL_PREF：值为5，本地优先，**公认任意**属性，1+1+4总共6字节
- ATOMIC_AGGREGATE：值为6，**公认任意**属性，2字节
- AGGREGATOR：值为7，**可选传递**属性，1字节type+1字节length+2字节AS号+4字节IP地址

NLRI网络层可达信息是路由更新的核心字段，用于明确通告可达的网络前缀及其属性。
格式​：<Length (1字节), Prefix (可变长度)>
length：前缀的掩码长度（0~32位，IPv4；0~128位，IPv6）。
Prefix​：网络地址的二进制表示（长度由Length字段决定）。

### 4.4 keepalive保活报文消息格式

KEEPALIVE的长度为19个八位字节。
keepalive报文的发送频率一般是hold time字段的1/3，如果设置为0则不使用keepalive保活机制。

### 4.5 notification报文格式

当检测到错误情况时，将发送notification报文，BGP连接在发送后立即关闭。

![notification报文格式示意图](image-6.png)

notification报文最短长度=19+1字节错误码+1字节子错误码
data是可选项，此可变长度字段用于诊断通知的原因。
具体类型不再赘述。

## 5.路径属性

路径属性分为四大类：

- 公认必遵：**必须**能够识别，且**必须**存在于Update报文中
- 公认可选：必须识别，但**不强制要求**存在于Update报文中。
- 可选过渡：可不识别，必须传递
- 可选不过渡：可不识别，忽略该属性且**不传递给其他peer**

update报文的发送方需要按照type code升序构建报文，**为了兼容各方设备**接收方需要有接收type code乱序的能力。若接收方发现属性重复的update报文，则直接丢弃该报文。

### 5.1路径属性用法

#### 5.1.1来源origin

origin来源标识路由信息的来源，公认必遵。**值越小优先级越高**

- 0：IGP协议，IBGP协议或者network手动注入标记为0
- 1：EGP协议
- 2：incomplete不完整的，import route手动引入

#### 5.1.2 AS_PATH

AS_PATH**按顺序记录**路由经过的所有AS编号，公认必遵。

当BGP speaker向不同邻居传播路由时，AS_PATH的修改方式取决于邻居类型和策略配置​：

- 向EBGP邻居传播：在AS_PATH最左侧添加本地AS号
- 向IBGP邻居传播:保持原始路径

注意：
当BGP speaker发送路由信息时会把本地的AS号加到这个AS_PATH中。

#### 5.1.3 next hop下一跳

next hop下一跳记录路由信息下一个目的地，公认必遵。

next hop的**设置规则**：

- ​EBGP邻居间传播：下一跳属性设置为建立EBGP会话的接口IP地址(即使用自己的IP作为下一跳)
- IBGP邻居间传播：下一跳属性保持不变
- 本地始发路由：network命令注入则下一跳默认为0.0.0.0，后续替换为源IP地址。

next hop的**处理规则**：

- 单跳BGP:TTL=1,EBGP直接使用使用邻居接口IP作为下一跳.若IBGP邻居为直连，下一跳仍保持原始值,如果是使用多跳建立的IBGP会话需要配置最大跳数。
- 多跳BGP:EBGP或IBGP邻居通过中间设备建立会话.EBGP多跳则下一跳仍为建立会话的接口IP。IBGP多跳则下一跳默认保持原始值。

路由匹配原则：

- 1.先找**完全匹配**的路由，从上往下遍历，如果匹配上就使用。
- 2.找不到完全匹配就使用**最长掩码匹配**。
- 3.路由等价则根据**路由策略选择**

#### 5.1.4 MED

MED是一个可选非传递属性，用于EBGP连接间**选择最优路径**。MED值越小，路径越优。BGP设备**必须在路由选路流程的前两个阶段**​（优先级计算和路由选择）之前通过本地配置移除MED属性，否则可能影响选路结果。

#### 5.1.5 local_pref 本地优先

local_perf 本地优先是BGP的**公认任意属性**，用于在同一AS内部的IBGP对等体之间选择最佳出口路径。其值越大，优先级越高。
**内部传播**时若未显式配置，LOCAL_PREF默认为100
**外部传播**时不得带上local_perf,BGP Confederations场景除外。

#### 5.1.6 ATOMIC_AGGREGATE路由聚合

ATOMIC_AGGREGATE路由聚合是BGP的**公认任意属性**，用于标识一条路由是经过聚合的。
ATOMIC_AGGREGATE路由聚合的作用：明确告知接收方该路由是多个明细路由的汇总结果，可能丢弃了部分明细路由的细节。**不跨AS传递**。
路由聚合的origin字段取聚合的路由中的origin字段间的较大值。

#### 5.1.7 AGGREGATOR

AGGREGATOR聚合器是BGP的**可选过渡属性**​，用于标识聚合路由的生成者信息，包含聚合路由的AS号和生成该聚合路由的路由器ID。

AGGREGATOR聚合器的核心作用：

- 溯源聚合来源​：明确告知接收方该聚合路由是由哪个AS的哪台设备生成的。
- ​辅助防环与策略控制​：结合AS_PATH等属性，避免因聚合导致的环路或策略失效。

## 6.BGP 错误处理
